---
phase: 03-gem-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TidalsGemMiner/src/main/java/tasks/Cut.java
  - TidalsGemMiner/src/main/java/tasks/Bank.java
  - TidalsGemMiner/src/main/java/main/TidalsGemMiner.java
autonomous: true

must_haves:
  truths:
    - "Script cuts all gems player can cut when inventory is full"
    - "Script drops crushed gems after cutting"
    - "Script deposits cut gems when cutting enabled"
    - "Script deposits raw gems when cutting disabled"
  artifacts:
    - path: "TidalsGemMiner/src/main/java/tasks/Cut.java"
      provides: "Gem cutting with dialogue handling and crushed gem dropping"
      min_lines: 80
    - path: "TidalsGemMiner/src/main/java/tasks/Bank.java"
      provides: "Deposit box banking for cut or raw gems"
      min_lines: 60
  key_links:
    - from: "Cut.java"
      to: "DialogueType.ITEM_OPTION"
      via: "selectItem with UNCUT gem ID"
      pattern: "selectItem.*UNCUT"
    - from: "Cut.java"
      to: "inventory drop"
      via: "drop crushed gems after cutting"
      pattern: "CRUSHED_GEM.*drop|drop.*1633"
    - from: "Bank.java"
      to: "deposit box/chest"
      via: "interact with location-specific deposit object"
      pattern: "depositObjectName|Deposit"
---

<objective>
Implement gem cutting and banking tasks for Phase 3: Gem Processing.

Purpose: Complete the gem processing workflow so mined gems can be cut and banked.
Output: Cut.java and Bank.java tasks, integrated into main task list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# prior phase context (decisions, patterns established)
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/02-mining/02-01-SUMMARY.md

# gem cutting patterns (CRITICAL - read before implementing Cut task)
@examples/gem-cutting.md

# banking patterns
@docs/banking-patterns.md

# existing source files
@TidalsGemMiner/src/main/java/main/TidalsGemMiner.java
@TidalsGemMiner/src/main/java/tasks/Mine.java
@TidalsGemMiner/src/main/java/data/Locations.java
@TidalsGemMiner/src/main/java/utils/Task.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cut task with gem cutting and crushed gem dropping</name>
  <files>TidalsGemMiner/src/main/java/tasks/Cut.java</files>
  <action>
Create Cut.java extending Task with:

**Gem data:**
- Define UNCUT gem IDs with crafting level requirements:
  - Opal (1625, level 1), Jade (1627, level 13), Red topaz (1629, level 16)
  - Sapphire (1623, level 20), Emerald (1621, level 27), Diamond (1617, level 43)
  - Ruby (1619, level 63), Dragonstone (1631, level 55)
- CRUSHED_GEM_ID = 1633
- CHISEL_ID = 1755

**activate():**
- Return true when: setupDone AND cuttingEnabled AND inventory is full AND has uncut gems player can cut

**execute():**
- Set task = "Cutting gems"
- Get player crafting level via getSkillManager().getLevel(Skill.CRAFTING)
- Find highest-level cuttable uncut gem in inventory
- If no uncut gems: return false (let Bank task take over)
- Use chisel on uncut gem via SearchableItem.useOn()
- Wait for ITEM_OPTION dialogue (pollFramesUntil, 4-6 seconds)
- CRITICAL: Select the UNCUT gem ID in dialogue (not cut gem!) per gem-cutting.md
- Wait for cutting animation to complete (poll until no longer animating or gem consumed)
- After all cutting complete, drop crushed gems:
  - Search inventory for CRUSHED_GEM_ID
  - For each crushed gem, interact("Drop")
- Increment gemsCut counter for each successful cut
- Return false to re-evaluate state

**Patterns to follow:**
- Use static imports from TidalsGemMiner for state fields
- Follow dialogue pattern from gem-cutting.md exactly (select UNCUT gem ID)
- Use pollFramesUntil for timing, not Thread.sleep
  </action>
  <verify>JAVA_HOME=$(/usr/libexec/java_home -v 17) gradle -p TidalsGemMiner build --no-daemon compiles without errors</verify>
  <done>Cut.java exists, compiles, handles all gem types based on crafting level, drops crushed gems</done>
</task>

<task type="auto">
  <name>Task 2: Create Bank task for depositing gems</name>
  <files>TidalsGemMiner/src/main/java/tasks/Bank.java</files>
  <action>
Create Bank.java extending Task with:

**activate():**
Return true when: setupDone AND inventory is full AND one of:
- Cutting disabled (deposit raw gems)
- Cutting enabled AND no uncut gems left in inventory (cutting complete, deposit cut gems)

**execute():**
- Set task = "Banking"
- Get current position and check if near bank
- If not near bank: walk to selectedLocation.bankPosition() using Walker
- Find deposit object by selectedLocation.depositObjectName() (Bank Deposit Box or Bank Deposit Chest)
- Interact with deposit action from selectedLocation.depositAction()
- Wait for deposit box/chest to be visible
- Wait 300-500ms for UI to load (per banking-patterns.md)
- Call depositAll() with empty keep set (deposit everything, chisel stays because it's equipped via tool belt or kept because we're using deposit box which only deposits inventory)
- Wait 300-600ms for deposit to complete
- Close deposit interface
- Set task = "Returning to mine"
- Walk back to selectedLocation.minePosition()
- Return false to re-evaluate state

**Key patterns:**
- Use DepositBox from getWidgetManager().getDepositBox() for deposit boxes
- Deposit objects are location-specific (Locations.java has the names)
- Use pollFramesUntil for waits, not Thread.sleep
- Use RetryUtils or manual retry loop for object interactions
  </action>
  <verify>JAVA_HOME=$(/usr/libexec/java_home -v 17) gradle -p TidalsGemMiner build --no-daemon compiles without errors</verify>
  <done>Bank.java exists, compiles, handles both deposit box and chest based on location, walks to/from bank</done>
</task>

<task type="auto">
  <name>Task 3: Add Cut and Bank tasks to main script</name>
  <files>TidalsGemMiner/src/main/java/main/TidalsGemMiner.java</files>
  <action>
Update TidalsGemMiner.java:

**Imports:**
- Add import for tasks.Cut
- Add import for tasks.Bank

**Task list initialization in onStart():**
- Add tasks in correct order: Setup → Cut → Bank → Mine
- Order matters: Cut must be before Bank (so cutting happens first when enabled)
- Bank must be before Mine (so banking happens before mining resumes)

The task list should be:
```java
tasks.add(new Setup(this));
tasks.add(new Cut(this));
tasks.add(new Bank(this));
tasks.add(new Mine(this));
```

Remove the comment about "banking, cutting tasks will be added in later phases" since we're adding them now.
  </action>
  <verify>JAVA_HOME=$(/usr/libexec/java_home -v 17) gradle -p TidalsGemMiner build --no-daemon compiles without errors</verify>
  <done>TidalsGemMiner.java has Cut and Bank tasks in correct order, script compiles</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `JAVA_HOME=$(/usr/libexec/java_home -v 17) gradle -p TidalsGemMiner build --no-daemon` succeeds
- [ ] Cut.java exists with gem cutting logic and crushed gem dropping
- [ ] Bank.java exists with deposit box/chest banking and walk-to-bank logic
- [ ] TidalsGemMiner.java has tasks in order: Setup → Cut → Bank → Mine
- [ ] All uncut gem types handled with correct crafting level checks
- [ ] Crushed gem (1633) dropping implemented after cutting
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No compilation errors
- Cut task handles dialogue correctly (selects UNCUT gem ID)
- Bank task works for both locations (deposit box vs chest)
- Task order ensures cutting happens before banking when enabled
</success_criteria>

<output>
After completion, create `.planning/phases/03-gem-processing/03-01-SUMMARY.md`
</output>
