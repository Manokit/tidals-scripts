---
phase: 05-restock-logic
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - utilities/src/main/java/utilities/loadout/LoadoutRestocker.java
autonomous: true
---

<objective>
Create the restocker that performs bank withdrawals and equipment handling.

Purpose: Enable scripts to restock a loadout from the bank with proper quantity mode handling.
Output: LoadoutRestocker class that withdraws missing items and equips gear.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-restock-logic/05-CONTEXT.md
@.planning/phases/05-restock-logic/05-01-SUMMARY.md

@utilities/src/main/java/utilities/loadout/Loadout.java
@utilities/src/main/java/utilities/loadout/LoadoutItem.java
@utilities/src/main/java/utilities/loadout/QuantityMode.java
@utilities/src/main/java/utilities/loadout/RestockResult.java
@utilities/src/main/java/utilities/loadout/MissingItem.java
@utilities/src/main/java/utilities/loadout/LoadoutComparator.java
@utilities/src/main/java/utilities/items/ItemResolver.java
@utilities/src/main/java/utilities/items/ItemVariantMap.java
@utilities/src/main/java/utilities/BankingUtils.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LoadoutRestocker for bank withdrawals</name>
  <files>utilities/src/main/java/utilities/loadout/LoadoutRestocker.java</files>
  <action>
Create LoadoutRestocker class that restocks a loadout from the bank:

**Constructor:**
- Takes Script script, ItemResolver itemResolver

**Main method:**
```java
public RestockResult restock(Loadout loadout)
```

**Logic:**

1. **Pre-check: Bank must be open**
   - Return RestockResult.failed() if bank not visible

2. **Compare current state to loadout**
   - Use LoadoutComparator to get missing items
   - If nothing missing, return RestockResult.success(empty)

3. **Separate equipment vs inventory missing items**
   - Equipment items handled first (equipment-first order from CONTEXT.md)
   - Process ContainerType.EQUIPMENT items before INVENTORY items

4. **Process MINIMUM mode items first (hard requirements)**
   - For each MINIMUM mode missing item:
     - Check bank has at least neededQuantity
     - If not, add to unfulfilled and set success=false
     - MINIMUM is a hard fail - script cannot proceed without these

5. **Withdraw equipment items**
   - For each missing equipment item:
     - Handle fuzzy matching: use ItemVariantMap.getPreferredVariant() when fuzzy=true
     - Search bank for item (or any variant if fuzzy)
     - Withdraw 1 (equipment is always quantity 1)
     - Track as restocked or unfulfilled

6. **Withdraw inventory items**
   - For each missing inventory item by mode:
     - EXACT: withdraw deficit amount (neededQuantity - currentQuantity)
     - UNLIMITED: withdraw all available from bank (use -1 or "All" withdraw)
     - MINIMUM: withdraw deficit amount
   - Handle fuzzy: prefer highest charge variant from bank
   - Track as restocked or unfulfilled (soft fail for EXACT/UNLIMITED)

7. **Return appropriate RestockResult**
   - success() if all items restocked
   - partial() if some restocked but MINIMUM unmet
   - failed() if critical failure (bank closed, etc.)

**Quantity mode behavior (from CONTEXT.md):**
- EXACT: soft requirement - take what's available, don't fail
- UNLIMITED: soft requirement - take entire stack, don't fail
- MINIMUM: hard requirement - fail restock if unmet

**Bank withdrawal:**
- Use script.getWidgetManager().getBank().withdraw(itemId, amount)
- For UNLIMITED, use withdraw with -1 (all) or large number
- Add human-like delays between withdrawals (100-300ms)

**Fuzzy withdrawal:**
- When LoadoutItem.isFuzzy() is true, search bank for any variant
- Prefer highest charge variant using ItemVariantMap.getPreferredVariant()
- Fall back to any available variant if preferred not in bank
  </action>
  <verify>gradle :utilities:compileJava succeeds with no errors</verify>
  <done>LoadoutRestocker.restock() withdraws missing items from bank with correct quantity mode handling</done>
</task>

<task type="auto">
  <name>Task 2: Add equipment handling for equip-from-inventory</name>
  <files>utilities/src/main/java/utilities/loadout/LoadoutRestocker.java</files>
  <action>
Add equipment handling to LoadoutRestocker:

**Add method:**
```java
public boolean equipFromInventory(Loadout loadout)
```

**Logic:**

1. After withdrawing equipment items to inventory, need to equip them
2. For each equipment slot in loadout:
   - If slot is null, skip
   - Check if already equipped (use Equipment widget)
   - If not equipped, find item in inventory and equip it

3. Use script.getWidgetManager().getInventory().interact(itemId, "Wear") or "Wield"
   - Action depends on item type (armor = Wear, weapon = Wield)
   - Can use generic "Equip" if available, or just click item for auto-equip

4. Wait for equip animation/delay between items (200-400ms)

5. Verify equipment after all equips

**Update restock() method:**
- After withdrawing, call equipFromInventory() for equipment items
- Only attempt equip for items that were successfully withdrawn
- Equipment-first means: withdraw equipment -> equip -> then withdraw inventory

**Consideration:**
- Equipment slots are specific (weapon slot, body slot, etc.)
- Don't need to handle slot positioning - just equipping the item puts it in right slot
- Some items can't be equipped if requirements not met (level, quest) - log warning but don't fail
  </action>
  <verify>gradle :utilities:compileJava succeeds with no errors</verify>
  <done>LoadoutRestocker equips gear from inventory after withdrawal, following equipment-first order</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gradle :utilities:compileJava succeeds
- [ ] gradle :utilities:build succeeds (full build with jar)
- [ ] LoadoutRestocker.restock() handles all three quantity modes
- [ ] MINIMUM mode failure causes restock to fail
- [ ] EXACT/UNLIMITED modes are soft requirements (partial success allowed)
- [ ] Equipment items are handled before inventory items
- [ ] Fuzzy matching prefers highest charge variant
- [ ] equipFromInventory() equips withdrawn gear
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No compilation errors
- Restocker integrates with existing BankingUtils patterns
- Equipment-first order respected
</success_criteria>

<output>
After completion, create `.planning/phases/05-restock-logic/05-02-SUMMARY.md`
</output>
