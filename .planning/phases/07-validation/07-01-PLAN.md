---
phase: 07-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [TidalsLoadoutTester/src/main/java/main/TidalsLoadoutTester.java, TidalsLoadoutTester/src/main/java/main/ScriptUI.java]
autonomous: true
---

<objective>
Complete TidalsLoadoutTester validation script with full workflow testing.

Purpose: Verify the entire loadout system works end-to-end — editor, persistence, comparison, and restock logic.
Output: Working test script that validates: create loadout → equip items → bank → verify restock fills only missing items.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-script-integration/06-02-SUMMARY.md

# Source files for this plan:
@TidalsLoadoutTester/src/main/java/main/TidalsLoadoutTester.java
@TidalsLoadoutTester/src/main/java/main/ScriptUI.java

# LoadoutManager API (facade for loadout operations):
@utilities/src/main/java/utilities/loadout/LoadoutManager.java
@utilities/src/main/java/utilities/loadout/LoadoutRestocker.java
@utilities/src/main/java/utilities/loadout/LoadoutComparator.java

# Reference existing test script pattern:
@TidalsBankTester/src/main/java/main/TidalsBankTester.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite TidalsLoadoutTester with state machine</name>
  <files>TidalsLoadoutTester/src/main/java/main/TidalsLoadoutTester.java</files>
  <action>
Rewrite the main script to use a state machine pattern with the following states:

**States:**
- SETUP: Show ScriptUI, wait for user to configure loadout and start
- VALIDATE_LOADOUT: Check that loadout has at least 1 equipment + 1 inventory item
- OPEN_BANK: Open bank to begin test
- DEPOSIT_ALL: Deposit everything to start with clean slate
- FIRST_RESTOCK: Call LoadoutManager.restock() - should withdraw and equip everything
- VERIFY_FIRST_RESTOCK: Compare current state to loadout, verify nothing missing
- REMOVE_ONE_ITEM: Remove 1 inventory item (bank it) to create deficit
- SECOND_RESTOCK: Call restock again - should only withdraw the 1 missing item
- VERIFY_SECOND_RESTOCK: Verify restock filled only the missing item
- COMPLETE: Log success, show results

**Implementation:**
- Use LoadoutManager for all operations (showEditor, restock, needsRestock)
- Track test assertions: int passedAssertions, int failedAssertions
- Add helper methods: assertTrue(String name, boolean condition), logTestResult()
- Log each state transition clearly
- Use existing patterns from TidalsBankTester for bank operations
- Remove the old createSampleLoadout() and logLoadout() methods

**Key API usage:**
```java
LoadoutManager loadouts = new LoadoutManager(this, "TidalsLoadoutTester");
loadouts.showEditor();                    // opens editor popup
loadouts.saveToPreferences();             // persist for next time
RestockResult result = loadouts.restock(); // withdraw missing from bank
boolean missing = loadouts.needsRestock(); // check if anything missing
```
  </action>
  <verify>Script compiles with `osmb build TidalsLoadoutTester`</verify>
  <done>State machine implemented with all states, LoadoutManager integration, assertion tracking</done>
</task>

<task type="auto">
  <name>Task 2: Update ScriptUI for test configuration</name>
  <files>TidalsLoadoutTester/src/main/java/main/ScriptUI.java</files>
  <action>
Update the ScriptUI to support the validation workflow:

**Changes:**
- Keep "Edit Loadout" button (calls LoadoutManager.showEditor())
- Add checkbox: "Editor Test Only" (default unchecked) - when checked, only test editor UI, skip full workflow
- Add status label showing loadout summary: "Equipment: X items, Inventory: Y items"
- Update status label after editor closes
- Start button validates loadout has items before allowing start (if not editor-only mode)
- Store reference to LoadoutManager (passed from main script) instead of raw Loadout

**Layout:**
```
[Title: Loadout Tester]
[Version label]

[Edit Loadout button]
[Status: Equipment: 2, Inventory: 5]

[x] Editor Test Only

[Start Test button]
```

**Color scheme:** Keep existing ocean theme colors.

**Callback:** When start button clicked:
- If "Editor Test Only": close window, script stays in SETUP state (existing behavior)
- If full workflow: close window, script transitions to VALIDATE_LOADOUT state
  </action>
  <verify>Script compiles with `osmb build TidalsLoadoutTester`</verify>
  <done>ScriptUI updated with LoadoutManager reference, status label, editor-only checkbox</done>
</task>

<task type="auto">
  <name>Task 3: Add paint overlay for test progress</name>
  <files>TidalsLoadoutTester/src/main/java/main/TidalsLoadoutTester.java</files>
  <action>
Add a paint overlay following the standard pattern from docs/Paint.md:

**Paint content:**
- Header: "Loadout Tester" with runtime
- Current state (e.g., "FIRST_RESTOCK", "VERIFY_SECOND_RESTOCK")
- Test progress: "Assertions: X passed, Y failed"
- Last action result (e.g., "Restock: SUCCESS", "Verification: PASSED")
- Loadout summary: "Equipment: X/14, Inventory: Y/28"

**Implementation:**
- Add `private long startTime` in onStart()
- Override onPaint(Graphics2D g2d) method
- Use standard colors: BG rgba(22,49,52,200), gold #ffd700, white #ffffff
- Draw rounded rectangle background
- Format runtime as HH:MM:SS
- Track lastActionResult string for display

**Position:** Top-left corner (10, 10), width 220, height ~120
  </action>
  <verify>Script compiles with `osmb build TidalsLoadoutTester`</verify>
  <done>Paint overlay shows state, assertions, runtime, and test progress</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `osmb build TidalsLoadoutTester` succeeds without errors
- [ ] Script has state machine with all required states
- [ ] LoadoutManager used for all loadout operations
- [ ] ScriptUI has editor button, status label, editor-only checkbox
- [ ] Paint overlay displays current state and test progress
</verification>

<success_criteria>
- All tasks completed
- Script compiles successfully
- State machine covers full test workflow
- Paint overlay provides test visibility
- No TypeScript/Java errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-validation/07-01-SUMMARY.md`
</output>
