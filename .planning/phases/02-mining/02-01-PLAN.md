---
phase: 02-mining
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TidalsGemMiner/src/main/java/data/Locations.java
  - TidalsGemMiner/src/main/java/tasks/Mine.java
  - TidalsGemMiner/src/main/java/main/TidalsGemMiner.java
autonomous: true

must_haves:
  truths:
    - "Script mines gem rocks at upper location when selected"
    - "Script mines gem rocks at underground location when selected"
    - "Script walks to mine area if player starts outside zone"
    - "Script waits for respawns when rocks are depleted"
    - "Script hops worlds at upper location when all rocks depleted"
    - "Script stops with error if stuck for extended period"
  artifacts:
    - path: "TidalsGemMiner/src/main/java/tasks/Mine.java"
      provides: "Core mining task with rock detection, mining loop, failsafes"
      min_lines: 150
    - path: "TidalsGemMiner/src/main/java/data/Locations.java"
      provides: "Mining area bounds for position checking"
      contains: "miningArea"
  key_links:
    - from: "Mine.java"
      to: "ObjectManager"
      via: "getObjects() for gem rock detection"
      pattern: "getObjectManager\\(\\)\\.getObjects"
    - from: "Mine.java"
      to: "PixelAnalyzer"
      via: "findRespawnCircles() for depleted rock detection"
      pattern: "findRespawnCircles"
    - from: "Mine.java"
      to: "Walker"
      via: "walkTo() for positioning"
      pattern: "getWalker\\(\\)\\.walkTo"
    - from: "TidalsGemMiner.java"
      to: "Mine.java"
      via: "tasks.add(new Mine)"
      pattern: "new Mine\\(this\\)"
---

<objective>
Implement the core mining loop for gem rocks at Shilo Village with failsafes.

Purpose: Enable the script to mine gem rocks at either upper or underground location, handling all edge cases (depleted rocks, player out of position, stuck states) without getting stuck.

Output: Working Mine task that mines nearest available gem rock, walks back when out of area, waits for respawns, hops worlds when upper location is depleted, and stops if stuck too long.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

# codebase context
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# phase context from discuss-phase
@.planning/phases/02-mining/02-CONTEXT.md

# existing source files
@TidalsGemMiner/src/main/java/main/TidalsGemMiner.java
@TidalsGemMiner/src/main/java/data/Locations.java
@TidalsGemMiner/src/main/java/tasks/Setup.java
@TidalsGemMiner/src/main/java/utils/Task.java

# reference implementations
@examples/gem-miner/src/tasks/MineTask.java
@examples/dAmethystMiner/src/main/java/tasks/MineTask.java

# api documentation
@docs/Walker.md
@docs/api-reference.md
@docs/critical-concepts.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Locations with mining area bounds</name>
  <files>TidalsGemMiner/src/main/java/data/Locations.java</files>
  <action>
Add mining area bounds to MiningLocation record and location instances.

1. Add `com.osmb.api.location.Area` field to MiningLocation record for mining area bounds
2. Define UPPER mining area around WorldPosition(2823, 2999, 0) — roughly 10 tile radius
3. Define UNDERGROUND mining area around the gem rocks area — check examples/gem-miner for reference positions
4. Update record constructor call sites (UPPER, UNDERGROUND) with area bounds

Use rectangular Area since gem rocks are in roughly rectangular zones. The area is for "am I in the mining zone?" checks, not precise rock positions.

Reference examples/gem-miner/src/data/Locations.java if it has area definitions.
  </action>
  <verify>Script compiles: `cd TidalsGemMiner && JAVA_HOME=$(/usr/libexec/java_home -v 17) ../gradlew build`</verify>
  <done>MiningLocation record has miningArea field, both locations have area bounds defined</done>
</task>

<task type="auto">
  <name>Task 2: Create Mine task with core mining loop</name>
  <files>TidalsGemMiner/src/main/java/tasks/Mine.java, TidalsGemMiner/src/main/java/main/TidalsGemMiner.java</files>
  <action>
Create Mine.java task that handles the core mining loop. Follow patterns from examples/gem-miner/src/tasks/MineTask.java.

**Mine.java implementation:**

1. **activate():** Returns true when setupDone is true AND inventory is not full. Check inventory via `getWidgetManager().getInventory().search(Collections.emptySet())` and `result.isFull()`.

2. **execute() core loop:**
   - Update `task` state to "Mining"
   - Get player position via `script.getWorldPosition()`
   - Get respawn circle positions via `getPixelAnalyzer().findRespawnCircles()` + `getUtils().getWorldPositionForRespawnCircles()`
   - Find available gem rocks:
     ```java
     script.getObjectManager().getObjects(obj ->
         obj != null &&
         obj.isInteractableOnScreen() &&
         obj.getName() != null &&
         obj.getName().equalsIgnoreCase("Gem rocks") &&
         obj.getActions() != null &&
         Arrays.asList(obj.getActions()).contains("Mine") &&
         !respawnCircles.contains(obj.getWorldPosition())
     );
     ```
   - Sort by distance to player position (nearest first)
   - Wait for player to be idle (not animating, not moving)
   - Tap nearest rock with "Mine" action using shrunk convex hull (0.7 resize)
   - Wait for mining completion (respawn circle appears OR inventory full OR timeout)
   - Increment `gemsMined` counter on success (track via XP gain like examples do)
   - Return false to re-evaluate state

3. **Helper methods:**
   - `isInventoryFull()` — check via inventory search
   - `getRespawnCirclePositions()` — wrap PixelAnalyzer call
   - `waitForPlayerIdle()` — use Timer to detect stationary + not animating
   - `waitForMiningCompletion(WorldPosition rockPos)` — poll until respawn circle at position OR inventory full

4. **Add Mine to task list in TidalsGemMiner.java:**
   - Add `tasks.add(new Mine(this));` after Setup in onStart()
   - Add import for `tasks.Mine`

**Critical patterns (from examples):**
- Use `submitHumanTask()` for waiting loops with timeout
- Shrink convex hull to 0.7 for more reliable clicks
- Track "waiting for respawn" positions to avoid re-clicking depleted rocks
- Use `tapGetResponse` with false (don't auto-tap) to verify action before executing

**DO NOT add failsafes yet** — that's Task 3. Just get basic mining working.
  </action>
  <verify>
1. Script compiles: `cd TidalsGemMiner && JAVA_HOME=$(/usr/libexec/java_home -v 17) ../gradlew build`
2. Mine task exists and is imported in main script
  </verify>
  <done>Mine.java created with rock detection, mining loop, and completion waiting. Added to task list in main script.</done>
</task>

<task type="auto">
  <name>Task 3: Add failsafes to Mine task</name>
  <files>TidalsGemMiner/src/main/java/tasks/Mine.java</files>
  <action>
Add failsafe behaviors to Mine.java execute() method.

**1. Walk-back when outside mining area:**
At start of execute(), check if player is in mining area:
```java
WorldPosition myPos = script.getWorldPosition();
if (myPos == null) return false;

if (!selectedLocation.miningArea().contains(myPos)) {
    task = "Walking to mine";
    script.log(getClass(), "Outside mining area, walking back");
    WorldPosition target = selectedLocation.minePosition();
    if (target != null) {
        script.getWalker().walkTo(target, new WalkConfig.Builder()
            .breakCondition(() -> hasMineableRockOnScreen())
            .build());
    }
    return false;
}
```

**2. Handle no rocks available (all depleted):**
If gemRocks list is empty after filtering:
- For UNDERGROUND: Just wait and return false (rocks respawn quickly, plenty available)
- For UPPER: World hop because limited rocks
```java
if (gemRocks.isEmpty()) {
    script.log(getClass(), "No available gem rocks");
    if (selectedLocation.name().equals("upper")) {
        task = "Hopping worlds";
        script.log(getClass(), "Upper mine depleted, hopping worlds");
        script.getProfileManager().forceHop();
    } else {
        task = "Waiting for respawn";
    }
    return false;
}
```

**3. Stuck detection with timeout:**
Add a stuck timer that tracks time since last successful mine action:
- Instance field: `private long lastSuccessfulAction = 0;`
- After successful mine (XP gained or respawn detected): `lastSuccessfulAction = System.currentTimeMillis();`
- At start of execute(), check if stuck too long:
```java
private static final long STUCK_TIMEOUT_MS = 5 * 60 * 1000; // 5 minutes

// in execute()
if (lastSuccessfulAction > 0) {
    long timeSinceSuccess = System.currentTimeMillis() - lastSuccessfulAction;
    if (timeSinceSuccess > STUCK_TIMEOUT_MS) {
        script.log(getClass(), "Stuck for " + (timeSinceSuccess / 1000) + " seconds, stopping script");
        task = "STUCK - Stopping";
        script.stop();
        return false;
    }
}
```
- Initialize `lastSuccessfulAction = System.currentTimeMillis()` when first entering execute()

**4. Add helper method for break condition:**
```java
private boolean hasMineableRockOnScreen() {
    List<WorldPosition> respawnCircles = getRespawnCirclePositions();
    RSObject rock = script.getObjectManager().getRSObject(obj ->
        obj != null &&
        obj.isInteractableOnScreen() &&
        obj.getName() != null &&
        obj.getName().equalsIgnoreCase("Gem rocks") &&
        obj.getActions() != null &&
        Arrays.asList(obj.getActions()).contains("Mine") &&
        !respawnCircles.contains(obj.getWorldPosition())
    );
    return rock != null;
}
```

**Import needed:** `com.osmb.api.walker.WalkConfig`
  </action>
  <verify>
1. Script compiles: `cd TidalsGemMiner && JAVA_HOME=$(/usr/libexec/java_home -v 17) ../gradlew build`
2. Mine.java contains walk-back logic, world hop logic, and stuck timeout
  </verify>
  <done>Mine task has: walk-back when outside area, world hop for upper when depleted, stuck detection with 5-minute timeout</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd TidalsGemMiner && JAVA_HOME=$(/usr/libexec/java_home -v 17) ../gradlew build` succeeds
- [ ] Mine.java exists with activate(), execute(), and helper methods
- [ ] Mine task added to task list in TidalsGemMiner.java
- [ ] Locations.java has miningArea field and both locations have bounds
- [ ] Code handles: rock detection, respawn tracking, walk-back, world hop (upper), stuck timeout
</verification>

<success_criteria>
- All tasks completed
- Script compiles without errors
- Mine task implements full mining loop with failsafes
- Requirements MINE-01, MINE-02, MINE-04, MINE-05, MINE-06 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/02-mining/02-01-SUMMARY.md`
</output>
