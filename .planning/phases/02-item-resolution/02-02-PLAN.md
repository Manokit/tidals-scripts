---
phase: 02-item-resolution
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [utilities/src/main/java/utilities/items/SpriteCache.java, utilities/src/main/java/utilities/items/ItemResolver.java]
autonomous: true
---

<objective>
Create SpriteCache and ItemResolver classes for item lookup and sprite management.

Purpose: Provide unified item resolution with OSMB ItemManager as primary source, Jagex GE API fallback for gaps, and automatic name-to-ID reverse mapping since OSMB lacks that method.
Output: SpriteCache.java for caching, ItemResolver.java as main entry point for all item lookups.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-item-resolution/02-RESEARCH.md

# Phase 1 data model
@utilities/src/main/java/utilities/loadout/LoadoutItem.java

# Phase 2 Plan 01 output (variant mapping)
# Will reference: utilities/src/main/java/utilities/items/ItemVariantMap.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpriteCache class</name>
  <files>utilities/src/main/java/utilities/items/SpriteCache.java</files>
  <action>
Create SpriteCache class in utilities.items package:
- Private Map<Integer, Image> cache for storing sprites by item ID
- Constructor takes ScriptCore (needed for ItemManager access)
- getSprite(int itemId) method:
  1. Check cache first, return if hit
  2. Try script.getItemManager().getItemImage(itemId, 1, ZoomType.ZOOM_IN, null)
  3. If null, try fetchFromGEApi(itemId) as fallback
  4. Cache result (even null to avoid repeated lookups)
  5. Return sprite or null
- Private fetchFromGEApi(int itemId) method:
  - URL: https://secure.runescape.com/m=itemdb_oldschool/obj_sprite.gif?id={itemId}
  - Set User-Agent header, 5 second timeout
  - Use ImageIO.read() to load
  - Return null on any exception (network errors, 404s)
- clear() method to reset cache
- size() method for diagnostics

Note: Use java.awt.Image (not JavaFX Image) to match OSMB ItemManager return type.
  </action>
  <verify>javac compiles without errors</verify>
  <done>SpriteCache class exists with layered resolution (cache -> OSMB -> GE API)</done>
</task>

<task type="auto">
  <name>Task 2: Create ItemResolver class</name>
  <files>utilities/src/main/java/utilities/items/ItemResolver.java</files>
  <action>
Create ItemResolver class in utilities.items package:
- Private final ScriptCore script
- Private final SpriteCache spriteCache
- Private final Map<String, Integer> nameToId (reverse lookup)
- Private boolean initialized (lazy init flag)

Constructor:
- Takes ScriptCore
- Creates SpriteCache instance
- Does NOT build nameToId map yet (lazy init for performance)

Private ensureInitialized() method:
- If already initialized, return
- Build nameToId map from script.getItemManager().getItemDefinitions()
- Map lowercase name to ID for case-insensitive lookup
- Set initialized = true

Public methods:
- getSprite(int itemId) - delegates to SpriteCache
- getName(int itemId) - calls script.getItemManager().getItemName(itemId)
- getItemId(String name) - lazy init, lookup from nameToId map (returns null if not found)
- isVariantMatch(int loadoutItemId, int actualItemId) - uses ItemVariantMap.areVariants()
- getPreferredVariant(int itemId) - delegates to ItemVariantMap
- getAllVariants(int itemId) - delegates to ItemVariantMap

Add convenience method for loadout matching:
- matchesLoadoutItem(LoadoutItem loadoutItem, int actualItemId) - returns true if:
  - IDs match exactly, OR
  - loadoutItem.isFuzzy() and isVariantMatch() returns true
  </action>
  <verify>javac compiles, ItemResolver can be instantiated</verify>
  <done>ItemResolver provides unified interface for sprites, names, IDs, and variant matching</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd utilities && JAVA_HOME=$(/usr/libexec/java_home -v 17) gradle build` succeeds
- [ ] ItemResolver.getName(995) returns "Coins" (or similar gold coin name)
- [ ] ItemResolver.matchesLoadoutItem() correctly handles fuzzy matching
- [ ] No compile errors or warnings
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- SpriteCache provides layered resolution with fallback
- ItemResolver provides unified API for all item operations
- Lazy initialization of name-to-ID map for performance
</success_criteria>

<output>
After completion, create `.planning/phases/02-item-resolution/02-02-SUMMARY.md`
</output>
