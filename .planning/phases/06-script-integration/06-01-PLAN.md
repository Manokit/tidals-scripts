---
phase: 06-script-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - utilities/src/main/java/utilities/loadout/LoadoutPersistence.java
autonomous: true
---

<objective>
Add Java Preferences-based persistence for loadouts.

Purpose: Allow scripts to save and restore loadout configurations between sessions.
Output: LoadoutPersistence class that serializes/deserializes loadouts to Java Preferences.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/05-restock-logic/05-02-SUMMARY.md

# Existing loadout classes for serialization
@utilities/src/main/java/utilities/loadout/Loadout.java
@utilities/src/main/java/utilities/loadout/LoadoutItem.java
@utilities/src/main/java/utilities/loadout/QuantityMode.java

# Existing JSON export/import for format reference
@utilities/src/main/java/utilities/loadout/LoadoutExporter.java
@utilities/src/main/java/utilities/loadout/LoadoutImporter.java

# Existing ScriptUI for Preferences pattern reference
@TidalsGemCutter/src/main/java/main/ScriptUI.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LoadoutPersistence class</name>
  <files>utilities/src/main/java/utilities/loadout/LoadoutPersistence.java</files>
  <action>
Create LoadoutPersistence with static methods for saving/loading loadouts using Java Preferences.

Design:
- Use Preferences.userRoot().node("tidals/loadouts") as the storage node
- Key format: loadout name (sanitized to alphanumeric + underscore)
- Value: JSON string from LoadoutExporter (already have complete serialization)
- Methods:
  - `save(String key, Loadout loadout)` - saves to preferences
  - `load(String key)` - returns Loadout or null if not found
  - `delete(String key)` - removes a saved loadout
  - `list()` - returns List of saved loadout keys
  - `exists(String key)` - checks if a loadout exists
- Sanitize keys: replace non-alphanumeric chars with underscore, limit length to 80 chars
- Use LoadoutExporter.toJson() for serialization
- Use LoadoutImporter.fromJson() for deserialization
- Catch and log exceptions, returning null/false on failure (graceful degradation)
  </action>
  <verify>Build utilities jar: `cd tidals-scripts && JAVA_HOME=$(/usr/libexec/java_home -v 17) gradle :utilities:build`</verify>
  <done>LoadoutPersistence compiles and exports save/load/delete/list/exists methods</done>
</task>

<task type="auto">
  <name>Task 2: Add default loadout support</name>
  <files>utilities/src/main/java/utilities/loadout/LoadoutPersistence.java</files>
  <action>
Add methods for script-specific default loadout storage:

- `saveDefault(String scriptName, Loadout loadout)` - saves as the default loadout for a script
- `loadDefault(String scriptName)` - loads the default loadout for a script
- `hasDefault(String scriptName)` - checks if script has a saved default
- `clearDefault(String scriptName)` - removes the default for a script

Key format: `_default_{scriptName}` (prefix with underscore to avoid collision with named loadouts)

This allows scripts to have a "remember my last loadout" feature without requiring users to name/manage loadouts explicitly.
  </action>
  <verify>Build utilities jar: `cd tidals-scripts && JAVA_HOME=$(/usr/libexec/java_home -v 17) gradle :utilities:build`</verify>
  <done>LoadoutPersistence includes default loadout methods for per-script defaults</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `gradle :utilities:build` succeeds without errors
- [ ] LoadoutPersistence has save/load/delete/list/exists methods
- [ ] LoadoutPersistence has saveDefault/loadDefault/hasDefault/clearDefault methods
- [ ] Keys are properly sanitized (alphanumeric + underscore only)
- [ ] Exceptions are caught and logged, not propagated
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- LoadoutPersistence provides complete persistence API using Java Preferences
</success_criteria>

<output>
After completion, create `.planning/phases/06-script-integration/06-01-SUMMARY.md`
</output>
