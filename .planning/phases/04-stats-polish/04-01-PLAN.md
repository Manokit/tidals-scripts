---
phase: 04-stats-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TidalsGemMiner/src/main/java/main/TidalsGemMiner.java
  - TidalsGemMiner/src/main/java/obf/Secrets.java
autonomous: true

must_haves:
  truths:
    - "Paint displays Mining XP/hr"
    - "Paint displays Crafting XP/hr"
    - "Paint displays gems mined count"
    - "Paint displays gems cut count"
    - "Logo displays in paint overlay"
    - "Stats report to dashboard every 10 minutes"
  artifacts:
    - path: "TidalsGemMiner/src/main/java/main/TidalsGemMiner.java"
      provides: "XP tracking, enhanced paint overlay, stats reporting"
      contains: "STATS_INTERVAL_MS"
    - path: "TidalsGemMiner/src/main/java/obf/Secrets.java"
      provides: "API credentials for dashboard"
      contains: "STATS_URL"
  key_links:
    - from: "TidalsGemMiner.java"
      to: "obf.Secrets"
      via: "import for API credentials"
      pattern: "obf\\.Secrets\\.(STATS_URL|STATS_API)"
    - from: "poll()"
      to: "sendStats()"
      via: "periodic stats check"
      pattern: "nowMs - lastStatsSent >= STATS_INTERVAL_MS"
---

<objective>
Add XP tracking, enhance paint overlay with XP/hr stats, and implement dashboard reporting.

Purpose: Complete the stats and polish phase - the final feature set for v1 release.
Output: Working paint overlay with all stats, dashboard reporting every 10 minutes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gem-processing/03-01-SUMMARY.md

# Reference patterns
@docs/Paint.md
@docs/Reporting-data.md

# Current implementation
@TidalsGemMiner/src/main/java/main/TidalsGemMiner.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add XP tracking with XPTrackers</name>
  <files>TidalsGemMiner/src/main/java/main/TidalsGemMiner.java</files>
  <action>
    Add XP tracking infrastructure:

    1. Add imports:
       - `com.osmb.api.skill.SkillType`
       - `com.osmb.api.skill.tracker.XPTracker`

    2. Add static fields after existing counters:
       ```java
       // XP tracking
       public static int miningXpGained = 0;
       public static int craftingXpGained = 0;
       private XPTracker miningTracker;
       private XPTracker craftingTracker;
       ```

    3. In onStart() after tasks initialization, add:
       ```java
       // initialize XP trackers
       miningTracker = getXPTrackers().get(SkillType.MINING);
       craftingTracker = getXPTrackers().get(SkillType.CRAFTING);
       if (miningTracker != null) miningTracker.reset();
       if (craftingTracker != null) craftingTracker.reset();
       ```

    4. At the START of poll() method (before task loop), add XP update:
       ```java
       // update XP counters
       if (miningTracker != null) {
           miningXpGained = miningTracker.getXPGained();
       }
       if (craftingTracker != null) {
           craftingXpGained = craftingTracker.getXPGained();
       }
       ```

    Pattern: Uses getXPTrackers().get(SkillType.X) per Phase 3 SUMMARY - this is the correct OSMB API.
  </action>
  <verify>Build succeeds with `osmb build TidalsGemMiner`</verify>
  <done>XP tracking fields and trackers added, XP updates in poll()</done>
</task>

<task type="auto">
  <name>Task 2: Enhance paint overlay with XP/hr stats</name>
  <files>TidalsGemMiner/src/main/java/main/TidalsGemMiner.java</files>
  <action>
    Enhance onPaint() method to display XP/hr:

    1. Add number formatter at class level (after FONT constants):
       ```java
       private static final java.text.DecimalFormat intFmt;
       static {
           intFmt = new java.text.DecimalFormat("#,###");
           java.text.DecimalFormatSymbols sym = new java.text.DecimalFormatSymbols();
           sym.setGroupingSeparator('.');
           intFmt.setDecimalFormatSymbols(sym);
       }
       ```

    2. In onPaint(), after calculating elapsed/runtime, add XP/hr calculations:
       ```java
       double hours = Math.max(1e-9, elapsed / 3_600_000.0);
       int miningXpHr = (int) (miningXpGained / hours);
       int craftingXpHr = (int) (craftingXpGained / hours);
       ```

    3. Update lineCount from 6 to 8 (adding Mining XP/hr and Crafting XP/hr)

    4. After "Gems mined" stat line, add XP stats:
       ```java
       curY += lineGap;
       drawStatLine(c, innerX, innerWidth, paddingX, curY, "Mining XP/hr", intFmt.format(miningXpHr), textMuted.getRGB(), accentGold.getRGB());

       if (cuttingEnabled) {
           curY += lineGap;
           drawStatLine(c, innerX, innerWidth, paddingX, curY, "Gems cut", String.valueOf(gemsCut), textMuted.getRGB(), valueGreen.getRGB());

           curY += lineGap;
           drawStatLine(c, innerX, innerWidth, paddingX, curY, "Crafting XP/hr", intFmt.format(craftingXpHr), textMuted.getRGB(), accentGold.getRGB());
       }
       ```

       Note: Move the existing "Gems cut" line into this block so Crafting XP/hr only shows when cutting is enabled.

    5. Adjust lineCount calculation for dynamic height:
       ```java
       int lineCount = cuttingEnabled ? 9 : 6;  // more lines when cutting enabled
       ```

    Layout order should be:
    - Runtime
    - Location
    - State
    - Gems mined
    - Mining XP/hr
    - [if cutting] Gems cut
    - [if cutting] Crafting XP/hr
    - [separator]
    - Mode
    - Version
  </action>
  <verify>Build succeeds with `osmb build TidalsGemMiner`</verify>
  <done>Paint overlay displays Mining XP/hr and Crafting XP/hr (when cutting enabled)</done>
</task>

<task type="auto">
  <name>Task 3: Add dashboard stats reporting</name>
  <files>TidalsGemMiner/src/main/java/obf/Secrets.java, TidalsGemMiner/src/main/java/main/TidalsGemMiner.java</files>
  <action>
    1. Create obf/Secrets.java:
       ```java
       package obf;

       // stats API credentials for dashboard reporting
       // this file is gitignored - never commit API keys
       public class Secrets {
           public static final String STATS_URL = "https://scripts.tidale.us/api/stats";
           public static final String STATS_API = "your-api-key-here";
       }
       ```

    2. Add imports to TidalsGemMiner.java:
       ```java
       import java.io.OutputStream;
       import java.net.HttpURLConnection;
       import java.net.URL;
       import java.nio.charset.StandardCharsets;
       import java.util.UUID;
       ```

    3. Add static fields for stats reporting (after XP tracking fields):
       ```java
       // stats reporting
       private static final String SCRIPT_NAME = "GemMiner";
       private static final String SESSION_ID = UUID.randomUUID().toString();
       private static final long STATS_INTERVAL_MS = 600_000L;  // 10 minutes
       private static long lastStatsSent = 0;

       // track last sent values for incremental reporting
       private static int lastSentMiningXp = 0;
       private static int lastSentCraftingXp = 0;
       private static int lastSentGemsMined = 0;
       private static int lastSentGemsCut = 0;
       private static long lastSentRuntime = 0;
       ```

    4. In poll(), AFTER the XP update block and BEFORE the task loop, add stats check:
       ```java
       // stats reporting
       long nowMs = System.currentTimeMillis();
       if (nowMs - lastStatsSent >= STATS_INTERVAL_MS) {
           long elapsed = nowMs - startTime;

           // calculate increments since last send
           int miningXpIncrement = miningXpGained - lastSentMiningXp;
           int craftingXpIncrement = craftingXpGained - lastSentCraftingXp;
           int gemsMinedIncrement = gemsMined - lastSentGemsMined;
           int gemsCutIncrement = gemsCut - lastSentGemsCut;
           long runtimeIncrement = (elapsed / 1000) - lastSentRuntime;

           sendStats(miningXpIncrement, craftingXpIncrement, gemsMinedIncrement, gemsCutIncrement, runtimeIncrement);

           // update last sent values AFTER sending
           lastSentMiningXp = miningXpGained;
           lastSentCraftingXp = craftingXpGained;
           lastSentGemsMined = gemsMined;
           lastSentGemsCut = gemsCut;
           lastSentRuntime = elapsed / 1000;
           lastStatsSent = nowMs;
       }
       ```

    5. Add sendStats() method (after formatRuntime):
       ```java
       private void sendStats(int miningXp, int craftingXp, int gemsMined, int gemsCut, long runtimeSecs) {
           try {
               if (obf.Secrets.STATS_URL == null || obf.Secrets.STATS_URL.isEmpty()) {
                   return;
               }

               // skip if nothing to report
               if (miningXp == 0 && craftingXp == 0 && gemsMined == 0 && gemsCut == 0 && runtimeSecs == 0) {
                   return;
               }

               // xp = mining + crafting combined for dashboard total
               int totalXp = miningXp + craftingXp;

               String json = String.format(
                   "{\"script\":\"%s\",\"session\":\"%s\",\"gp\":0,\"xp\":%d,\"runtime\":%d,\"gemsMined\":%d,\"gemsCut\":%d,\"miningXp\":%d,\"craftingXp\":%d}",
                   SCRIPT_NAME,
                   SESSION_ID,
                   totalXp,
                   runtimeSecs,
                   gemsMined,
                   gemsCut,
                   miningXp,
                   craftingXp
               );

               URL url = new URL(obf.Secrets.STATS_URL);
               HttpURLConnection conn = (HttpURLConnection) url.openConnection();
               conn.setRequestMethod("POST");
               conn.setDoOutput(true);
               conn.setConnectTimeout(5000);
               conn.setReadTimeout(5000);
               conn.setRequestProperty("Content-Type", "application/json");
               conn.setRequestProperty("X-Stats-Key", obf.Secrets.STATS_API);

               try (OutputStream os = conn.getOutputStream()) {
                   os.write(json.getBytes(StandardCharsets.UTF_8));
               }

               int code = conn.getResponseCode();
               if (code == 200) {
                   log("STATS", "Stats sent: miningXp=" + miningXp + ", craftingXp=" + craftingXp +
                       ", gems=" + gemsMined + "/" + gemsCut + ", runtime=" + runtimeSecs + "s");
               } else {
                   log("STATS", "Failed to send stats, HTTP " + code);
               }
           } catch (Exception e) {
               log("STATS", "Error sending stats: " + e.getClass().getSimpleName());
           }
       }
       ```

    CRITICAL: All numeric values are INCREMENTAL (gained since last report), not cumulative totals.
    Dashboard aggregates by adding values together.
  </action>
  <verify>Build succeeds with `osmb build TidalsGemMiner`</verify>
  <done>Stats report to dashboard every 10 minutes with incremental values</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `osmb build TidalsGemMiner` succeeds without errors
- [ ] XPTracker fields added for Mining and Crafting
- [ ] Paint overlay shows Mining XP/hr
- [ ] Paint overlay shows Crafting XP/hr (when cutting enabled)
- [ ] obf/Secrets.java created with placeholder API key
- [ ] sendStats() method sends incremental values every 10 minutes
</verification>

<success_criteria>

- All 3 tasks completed
- All verification checks pass
- Paint overlay displays all required stats (STAT-01 through STAT-06)
- Stats reporting implemented with incremental values
</success_criteria>

<output>
After completion, create `.planning/phases/04-stats-polish/04-01-SUMMARY.md`
</output>
