---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TidalsGemMiner/build.gradle
  - TidalsGemMiner/src/main/java/main/TidalsGemMiner.java
  - TidalsGemMiner/src/main/java/main/ScriptUI.java
  - TidalsGemMiner/src/main/java/tasks/Setup.java
  - TidalsGemMiner/src/main/java/utils/Task.java
  - TidalsGemMiner/src/main/java/data/Locations.java
  - TidalsGemMiner/src/main/resources/Tidals Gem Miner.png
autonomous: true

must_haves:
  truths:
    - "Script compiles with `osmb build TidalsGemMiner`"
    - "User can select mining location (Upper/Underground) in ScriptUI"
    - "User can toggle gem cutting option in ScriptUI"
    - "Settings persist between sessions via Preferences"
    - "Setup task validates chisel when cutting enabled"
  artifacts:
    - path: "TidalsGemMiner/build.gradle"
      provides: "Gradle build configuration with TidalsUtilities dependency"
      contains: "TidalsUtilities.jar"
    - path: "TidalsGemMiner/src/main/java/main/TidalsGemMiner.java"
      provides: "Main script with @ScriptDefinition, task list, paint overlay"
      contains: "@ScriptDefinition"
      min_lines: 80
    - path: "TidalsGemMiner/src/main/java/main/ScriptUI.java"
      provides: "Config dialog with location dropdown, cutting toggle"
      contains: "CheckBox"
      min_lines: 60
    - path: "TidalsGemMiner/src/main/java/tasks/Setup.java"
      provides: "Initial validation with chisel check"
      contains: "ItemID.CHISEL"
    - path: "TidalsGemMiner/src/main/java/data/Locations.java"
      provides: "MiningLocation enum with Upper/Underground"
      contains: "UPPER"
  key_links:
    - from: "ScriptUI.java"
      to: "TidalsGemMiner.java"
      via: "UI settings read by main script"
      pattern: "isCuttingEnabled|getSelectedLocation"
    - from: "TidalsGemMiner.java"
      to: "tasks"
      via: "Task list iteration in poll()"
      pattern: "task\\.activate\\(\\)"
    - from: "Setup.java"
      to: "chisel validation"
      via: "Inventory search for chisel"
      pattern: "ItemID\\.CHISEL"
---

<objective>
Create TidalsGemMiner project scaffolding with task architecture and ScriptUI configuration.

Purpose: Establish the foundation script structure that Phase 2-4 will build upon. Config UI allows users to select mining location and toggle gem cutting before mining code is implemented.

Output: Compilable script with working config UI, task framework ready for mining/banking/cutting tasks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Codebase patterns
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STRUCTURE.md

# Reference implementations
@tidals-scripts/TidalsCannonballThiever/src/main/java/main/ScriptUI.java
@tidals-scripts/TidalsGemCutter/src/main/java/utils/Task.java
@examples/gem-miner/src/data/Locations.java
@examples/gem-miner/src/main/GemMinerScript.java

# Gem cutting specifics
@examples/gem-cutting.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project scaffolding</name>
  <files>
    TidalsGemMiner/build.gradle,
    TidalsGemMiner/src/main/java/utils/Task.java,
    TidalsGemMiner/src/main/java/data/Locations.java
  </files>
  <action>
    1. Create build.gradle following TidalsCannonballThiever pattern:
       - Plugin: java
       - sourceCompatibility: 17
       - compileJava encoding: UTF-8
       - Dependencies: API.jar, TidalsUtilities.jar
       - Jar task outputs to jar/ directory

    2. Create utils/Task.java (copy from TidalsGemCutter):
       - Abstract class with Script field
       - Constructor takes Script
       - Abstract methods: activate(), execute() returning boolean

    3. Create data/Locations.java based on examples/gem-miner:
       - MiningLocation record with: name, displayName, minePosition, bankPosition, depositObjectName, depositAction, priorityRegions
       - UPPER location: WorldPosition(2823, 2999, 0), bank at (2852, 2953, 0), "Bank Deposit Box", region 11310
       - UNDERGROUND location: minePosition null (will walk to area), bank at (2842, 9383, 0), "Bank Deposit Chest", region 11410
       - fromDisplay() method for UI selection
  </action>
  <verify>
    Files exist at correct paths:
    - TidalsGemMiner/build.gradle
    - TidalsGemMiner/src/main/java/utils/Task.java
    - TidalsGemMiner/src/main/java/data/Locations.java
  </verify>
  <done>
    Project structure created with build config, Task base class, and Locations data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create main script class with paint overlay</name>
  <files>
    TidalsGemMiner/src/main/java/main/TidalsGemMiner.java,
    TidalsGemMiner/src/main/resources/Tidals Gem Miner.png
  </files>
  <action>
    1. Copy logo from project root to resources:
       - Source: TidalsGemMiner/Tidals Gem Miner.png â†’ TidalsGemMiner/src/main/resources/

    2. Create TidalsGemMiner.java following TidalsCannonballThiever pattern:
       - @ScriptDefinition: author="Tidal", name="Tidals Gem Miner", description="Mines gems at Shilo Village with optional cutting", skillCategory=MINING, version=1.0
       - Static state fields:
         - setupDone, task (String), startTime
         - selectedLocation (MiningLocation), cuttingEnabled (boolean)
         - gemsMined, gemsCut (int)
       - ScriptUI instance
       - Task list (ArrayList&lt;Task&gt;)
       - onStart(): create ScriptUI, show with getStageController(), init tasks after UI confirmed
       - poll(): iterate tasks, call activate/execute, return 0 (CRITICAL: every path returns int)
       - regionsToPrioritise(): return selectedLocation.priorityRegions()
       - onPaint(): draw overlay following TidalsCannonballThiever paint style:
         - Colors: BG_COLOR=#163134, BORDER_COLOR=#284b50, GOLD=#ffd700, TEXT_LIGHT=#eeede9
         - Show: logo, runtime, state, location, gems mined
         - Use drawStatLine helper for label/value alignment
       - Logo loading helper (try-with-resources, preserve ratio, fit width 180)
       - formatRuntime() helper

    CRITICAL: Every branch in poll() must return an int. Use explicit returns, not fall-through.
  </action>
  <verify>
    - File exists: TidalsGemMiner/src/main/java/main/TidalsGemMiner.java
    - File exists: TidalsGemMiner/src/main/resources/Tidals Gem Miner.png
    - Main class has @ScriptDefinition annotation
    - poll() method has return statements on all paths
  </verify>
  <done>
    Main script class compiles with paint overlay and task framework. All control flow paths return properly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ScriptUI with location and cutting options</name>
  <files>TidalsGemMiner/src/main/java/main/ScriptUI.java</files>
  <action>
    Create ScriptUI.java following TidalsCannonballThiever pattern with themed styling:

    1. Preferences node: "tidals_gem_miner"
       - PREF_LOCATION (String)
       - PREF_CUTTING_ENABLED (boolean)

    2. Color constants matching paint overlay:
       - BG_COLOR = "#163134"
       - BORDER_COLOR = "#284b50"
       - GOLD = "#ffd700"
       - TEXT_LIGHT = "#eeede9"
       - TEXT_MUTED = "#aab9b9"

    3. UI components:
       - Logo (loadLogo helper, fit width 180)
       - Version label
       - ComboBox&lt;MiningLocation&gt; for location selection
         - Use custom cell factory to display MiningLocation.displayName()
         - Default to UPPER from preferences
       - CheckBox for "Cut gems (drops crushed)" toggle
         - Description label explaining behavior
       - Start button (gold bg, styled hover state)

    4. buildScene() method:
       - VBox root with padding 20, spacing 16
       - Styled option boxes with border and background
       - Location dropdown with all locations from Locations class
       - Cutting checkbox with description text

    5. saveSettings() method:
       - Save location display name and cutting enabled to Preferences
       - Log settings

    6. Getter methods:
       - getSelectedLocation(): returns MiningLocation
       - isCuttingEnabled(): returns boolean

    7. loadLogo() helper:
       - Load from /Tidals Gem Miner.png resource
       - Return null gracefully on failure
  </action>
  <verify>
    - File exists: TidalsGemMiner/src/main/java/main/ScriptUI.java
    - Has ComboBox for location
    - Has CheckBox for cutting
    - Has Preferences persistence
  </verify>
  <done>
    ScriptUI displays location selection and cutting toggle. Settings persist between sessions.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Setup task with chisel validation</name>
  <files>TidalsGemMiner/src/main/java/tasks/Setup.java</files>
  <action>
    Create Setup.java following existing task patterns:

    1. Extends Task, constructor takes Script

    2. activate():
       - Return true if !TidalsGemMiner.setupDone
       - CRITICAL: Return false otherwise (explicit return)

    3. execute():
       - Log "Setting up..."
       - Set task = "Setup"
       - If cuttingEnabled:
         - Open inventory tab using TabUtils.openAndVerifyInventory()
         - Search inventory for ItemID.CHISEL (1755)
         - If no chisel found:
           - Log error "Chisel required when cutting is enabled!"
           - script.stop()
           - Return false
         - Log "Chisel found - cutting enabled"
       - Else:
         - Log "Cutting disabled - will bank raw gems"
       - Record startTime = System.currentTimeMillis()
       - Set setupDone = true
       - Return false (allow next task to run)

    CRITICAL: Every branch must have explicit return statement.

    Import: utilities.TabUtils, static main.TidalsGemMiner.*
  </action>
  <verify>
    - File exists: TidalsGemMiner/src/main/java/tasks/Setup.java
    - Has chisel validation logic
    - Uses ItemID.CHISEL (1755)
    - All branches return explicitly
  </verify>
  <done>
    Setup task validates chisel when cutting enabled. Stops script with error if chisel missing.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `osmb build TidalsGemMiner` completes successfully
- [ ] Script appears in OSMB script list
- [ ] ScriptUI shows location dropdown with Upper/Underground options
- [ ] ScriptUI shows cutting toggle checkbox
- [ ] Settings persist after closing and reopening UI
- [ ] With cutting enabled and no chisel: script stops with error
- [ ] With cutting disabled: setup completes successfully
- [ ] Paint overlay displays on screen
</verification>

<success_criteria>

- All 4 tasks completed
- Script compiles without errors
- ScriptUI functional with both settings
- Chisel validation works correctly
- Paint overlay renders
- All control flow paths have explicit returns
  </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
